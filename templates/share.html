{% extends "_base.html" %}
{% block title %}Share{% end %}
{% block main_div %}class="info"{% end %}

{% block body %}
    <div class="share">
        <noscript>
            <p>The internet would love if you shared your color schemes but it seems Javascript isn't enabled.  You'll need to it back on in order to use the share feature.</p>
        </noscript>

        <div class="upload">
            <h2>Share a Color Theme</h2>
            <!-- <span class="highlight">Multi-select</span> and <span class="highlight">Drag-and-Drop</span> supported by quality browsers. -->

            <p class="license">
                <img src="/static/img/cc-by-nc-sa.png" title="Creative Commons Attribution Non-Commercial Share Alike" />
                All content uploaded to Kolormodo.com is released to the public under the
                <a href="http://creativecommons.org/licenses/by-nc-sa/3.0" target="_blank">Creative Commons Attribution Non-Commercial Share Alike</a>.
            </p>
            <p class="license">
                This means others can download, use, and remix your color scheme.  They may upload their remix to this and
                other sites provided that they attribute you as the original author and that your original or their
                derivitive not be used for commercial gain.
            </p>

            <div id="file-uploader"></div>
            <span class="clear"></span>

            <fieldset class="agreement">
                <input type="checkbox" id="agreement" />
                <label for="agreement">
                    I certify that I have permission to upload the following files and
                    agree to release them under the license stated above.
                </label>
                {{ xsrf_form_html() }}
            </fieldset>

            <div class="common-locations">
                <h3>Common Color Scheme Locations by OS</h3>
                <table>
                    <tr>
                        <td class="os">Windows Vista &amp; 7</td>
                        <td>C:\Users\&lt;Your Username&gt;\AppData\Local\ActiveState\KomodoEdit\&lt;version&gt;\schemes</td>
                    </tr>
                    <tr>
                        <td class="os">Windows XP</td>
                        <td>C:\Document and Settings\&lt;Your Username&gt;\AppData\Local\ActiveState\KomodoEdit\&lt;version&gt;\schemes</td>
                    </tr>
                    <tr>
                        <td class="os">Ubuntu / Linux</td>
                        <td>~/.komodoedit/&lt;version&gt;/schemes</td>
                    </tr>
                    <tr>
                        <td class="os">Mac OSX</td>
                        <td>(someone <a href="mailto:webmaster@kolormodo.com">email me</a> and let me know)</td>
                    </tr>
                </table>
            </div>

        </div>

        <div id="active" style="display:none;">
            <img style="display:none;" src="/static/img/ajax-loader-long.gif" />
        </div>
    </div>
    &nbsp;
{% end %}

{% block head %}<link type="text/css" rel="stylesheet" href="/static/js/fileuploader/fileuploader.css" />{% end %}
{% block script %}
<script type="text/javascript" src="/static/js/fileuploader/fileuploader.js"></script>
<script type="text/javascript">
    // Stored temporarily here while in development, move to external file once it's more stabalized
    $(function() {
          Share.initUploader();
    });
    var Share = function() {
        return {
            initUploader: function() {
            $('#upload').show();
                var uploader = new qq.FileUploader({
                    element: $('#file-uploader')[0],
                    action: '/share/upload',
                    //allowedExtensions: ['ksf'],
                    onSubmit: function(id, filename) {
                        if ($('#agreement').attr('checked')) {
                            return true;
                        }
                        alert('You must agree to the terms of upload first.');
                        $('fieldset.agreement').css('background-color', '#C34D58').css('color', 'white').click(function(){
                            $(this).css('background-color', 'Transparent').css('color', 'inherit');
                        });

                        return false;
                    },
                    onComplete: Share.onUploadComplete,
                    onAllComplete: function() {
                        $('#upload').fadeOut(500, function() {
                            $('#active').fadeIn(500);
                        });
                    },
                    showMessage: function(message) {
                        alert(message);
                    }
                });
            },

            onUploadComplete: function(id, filename, json) {
                var template = '';
                template += '<div class="upload-preview" style="display:none;">';
                template += '    <h2 class="filename">%filename%</h2>';
                template += '    <div class="color-container" style="background-color:%bg%;"></div>';
                template += '    <fieldset>';
                template += '       <p>';
                template += '          <label for="title">Title</label>';
                template += '          <input type="text" class="title" value="%title%" />';
                template += '       </p>';
                template += '       <p>';
                template += '          <label for="desc">Short Description</label>';
                template += '          <input type="text" class="desc" value="" />';
                template += '       </p>';
                template += '       <p>';
                template += '           <input type="hidden" class="key" value="%key%" />';
                template += '           <a class="button save">Save</a>';
                template += '       </p>';
                template += '    </fieldset>';
                template += '</div>';

                template = template.replace('%filename%', json.filename);
                template = template.replace('%title%', json.title);
                template = template.replace('%bg%', json.background);
                template = template.replace('%key%', json.key);

                var upPreview = $(template);
                var colorContainer = upPreview.find('div.color-container');
                var key = upPreview.find('input.key').val();
                $.each(json.colors, function() {
                   $(colorContainer).append('<div class="color" style="background-color:%color%;" title="%color%"></div>'.replace(/%color%/g, this.toUpperCase()));
                });

                // Wire up save event
                upPreview.find('a.save').click(function() {
                    $(this).attr('disabled', 'disabled');
                    upPreview.append('<div class="fog"></div>');
                    upPreview.append('<img class="ajax-loader" src="/static/img/ajax-loader-long.gif" />');

                    var data = {
                        'key': key,
                        'title': upPreview.find('input.title').val(),
                        'description': upPreview.find('input.desc').val(),
                    }
                    $.post('/share/save', data, function(data, status, xhr){
                        // If no more schemes left, redirect to user's schemes view
                        if ($('#active').find('div.upload-preview').length == 1) {
                            window.location.href = '/my/schemes';
                        }
                        else {
                            upPreview.find('div.fog').remove();
                            upPreview.fadeOut(500, function(){
                                upPreview.remove();
                            });
                        }
                    });
                });

                $('#active').append(upPreview);
                upPreview.show();
            }
        }
    }();
</script>
{% end %}