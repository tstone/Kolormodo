{% extends "_base.html" %}
{% block title %}Share Color Schemes{% endblock %}

{% block body %}
    <h1>Upload Color Schemes</h1>
    <noscript>
        <p>We'd love to have you share your color schemes but it seems Javascript isn't enabled.  You'll need to it back on in order to use the share feature.</p>
    </noscript>

    <div id="upload" style="display:none;">
        <p>Choose the schemes you'd like to upload. &nbsp;<span class="highlight">Multi-select</span> and <span class="highlight">Drag-and-Drop</span> supported by quality browsers.<p>
            <h3>Common Color Scheme Locations</h3>
            <table class="common-locations">
                <tr>
                    <td class="os">Windows Vista &amp; 7</td>
                    <td>C:\Users\&lt;Your Username&gt;\AppData\Local\KomodoEdit\&lt;version&gt;\schemes</td>
                </tr>
                <tr>
                    <td class="os">Windows XP</td>
                    <td>C:\Document and Settings\&lt;Your Username&gt;\AppData\Local\KomodoEdit\&lt;version&gt;\schemes</td>
                </tr>
                <tr>
                    <td class="os">Ubuntu / Linux</td>
                    <td>~/.komodoedit/&lt;version&gt;/schemes</td>
                </tr>
                <tr>
                    <td class="os">Mac OSX</td>
                    <td>(someone email me and let me know)</td>
                </tr>
            </table>
        </p>
        <fieldset class="agreement">
            <input type="checkbox" id="agreement"><label for="agreement">I certify that I have permission to upload the following files and agree to release them under the Creative Commons license for others to freely used without compensation to myself.</label>
        </fieldset>
        <div id="file-uploader"></div>
    </div>

    <div id="active" style="display:none;">
        <img style="display:none;" src="/static/img/ajax-loader-long.gif" />
    </div>
    &nbsp;
{% endblock %}

{% block head %}<link type="text/css" rel="stylesheet" href="/static/js/fileuploader/fileuploader.css" />{% endblock %}
{% block script %}
<script type="text/javascript" src="/static/js/fileuploader/fileuploader.js"></script>
<script type="text/javascript">
    // Stored temporarily here while in development, move to external file once it's more stabalized
    google.setOnLoadCallback(function() {
      $(function() {
            Share.initUploader();
      });
    });
    var Share = function() {
        return {
            initUploader: function() {
            $('#upload').show();
                var uploader = new qq.FileUploader({
                    element: $('#file-uploader')[0],
                    action: '/share/upload',
                    //allowedExtensions: ['ksf'],
                    onSubmit: function(id, filename) {
                        if ($('#agreement').attr('checked')) {
                            return true;
                        }
                        alert('You must agree to the terms of upload first.');
                        $('fieldset.agreement').css('background-color', '#EB008B').css('color', 'white').click(function(){
                            $(this).css('background-color', 'white').css('color', 'inherit');
                        });

                        return false;
                    },
                    onComplete: Share.onUploadComplete,
                    onAllComplete: function() {
                        $('#upload').fadeOut(500, function() {
                            $('#active').fadeIn(500);
                        });
                    },
                    showMessage: function(message) {
                        alert(message);
                    }
                });
            },

            onUploadComplete: function(id, filename, json) {
                var template = '';
                template += '<div class="upload-preview" style="display:none;">';
                template += '    <h2 class="filename">%filename%</h2>';
                template += '    <div class="color-container" style="background-color:%bg%;"></div>';
                template += '    <fieldset>';
                template += '       <p>';
                template += '          <label for="title">Title</label>';
                template += '          <input type="text" class="title" value="%title%" />';
                template += '       </p>';
                template += '       <p>';
                template += '          <label for="desc">Short Description</label>';
                template += '          <input type="text" class="desc" value="" />';
                template += '       </p>';
                template += '       <p>';
                template += '           <input type="hidden" class="key" value="%key%" />';
                template += '           <a class="button save">Save</a>';
                template += '       </p>';
                template += '    </fieldset>';
                template += '</div>';

                template = template.replace('%filename%', json.filename);
                template = template.replace('%title%', json.title);
                template = template.replace('%bg%', json.background);
                template = template.replace('%key%', json.key);

                var upPreview = $(template);
                var colorContainer = upPreview.find('div.color-container');
                var key = upPreview.find('input.key').val();
                $.each(json.colors, function() {
                   $(colorContainer).append('<div class="color" style="background-color:%color%;" title="%color%"></div>'.replace(/%color%/g, this.toUpperCase()));
                });

                // Wire up save event
                upPreview.find('a.save').click(function() {
                    $(this).attr('disabled', 'disabled');
                    upPreview.append('<div class="fog"></div>');
                    upPreview.append('<img class="ajax-loader" src="/static/img/ajax-loader-long.gif" />');

                    var data = {
                        'key': key,
                        'title': upPreview.find('input.title').val(),
                        'description': upPreview.find('input.desc').val(),
                    }
                    $.post('/share/save', data, function(data, status, xhr){
                        // If no more schemes left, redirect to user's schemes view
                        if ($('#active').find('div.upload-preview').length == 1) {
                            window.location.href = '/my/schemes';
                        }
                        else {
                            upPreview.find('div.fog').remove();
                            upPreview.fadeOut(500, function(){
                                upPreview.remove();
                            });
                        }
                    });
                });

                $('#active').append(upPreview);
                upPreview.show();
            }
        }
    }();
</script>
{% endblock %}